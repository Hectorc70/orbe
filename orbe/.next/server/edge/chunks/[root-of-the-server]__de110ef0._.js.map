{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 23, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["// middleware.ts - Versión corregida\nimport { NextRequest, NextResponse } from \"next/server\";\n\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n  if (\n    pathname.startsWith('/_next/') ||\n    pathname.startsWith('/api/') ||\n    pathname.includes('.') ||\n    pathname === '/sw.js' ||\n    pathname.startsWith('/workbox-') ||\n    pathname === '/manifest.json'\n  ) {\n    return NextResponse.next();\n  }\n\n  console.log('🔄 Middleware ejecutándose para:', pathname);\n\n  // ✅ CORRECCIÓN: Obtener token de cookies (no localStorage)\n  const token = request.cookies.get('auth-token')?.value;\n  const userId = request.cookies.get('user-id')?.value;\n\n  console.log('🍪 Token en cookie:', token ? 'Presente' : 'Ausente');\n  console.log('🆔 User ID en cookie:', userId ? 'Presente' : 'Ausente');\n\n  // Verificar autenticación\n  const isAuthenticated = await isValidToken(token, userId);\n\n  // Rutas protegidas\n  const protectedRoutes = ['/dashboard', '/backend'];\n  const guestOnlyRoutes = ['/register', '/login'];\n\n  const isProtectedRoute = protectedRoutes.some(route => pathname.startsWith(route));\n  const isGuestOnlyRoute = guestOnlyRoutes.some(route => pathname.startsWith(route));\n\n  console.log('📍 Ruta:', pathname);\n  console.log('🔒 Protegida:', isProtectedRoute);\n  console.log('👤 Autenticado:', isAuthenticated);\n\n  // Lógica de redirección\n  if (isAuthenticated && isGuestOnlyRoute) {\n    console.log('✅ Usuario autenticado redirigido a dashboard');\n    const response = NextResponse.redirect(new URL('/dashboard', request.url));\n    response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');\n    return response;\n  }\n\n  if (!isAuthenticated && isProtectedRoute) {\n    console.log('❌ Usuario no autenticado redirigido a register');\n    const response = NextResponse.redirect(new URL('/register', request.url));\n    response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');\n    return response;\n  }\n\n  console.log('✅ Acceso permitido');\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\\\..*).+)'],\n};\n\nasync function isValidToken(token?: string, userId?: string): Promise<boolean> {\n  if (!token || !userId) {\n    console.log('❌ Token o userId ausente');\n    return false;\n  }\n\n  try {\n    // Opción 1: Validación local del JWT\n    if (token.split('.').length === 3) {\n      const payload = JSON.parse(atob(token.split('.')[1]));\n\n      // Verificar expiración\n      if (payload.exp && payload.exp * 1000 < Date.now()) {\n        console.log('❌ Token expirado');\n        return false;\n      }\n\n      // Verificar que el userId coincida\n      if (payload.sub !== userId && payload.userId !== userId && payload.id !== userId) {\n        console.log('❌ UserId no coincide');\n        return false;\n      }\n\n      console.log('✅ Token válido');\n      return true;\n    }\n\n    console.log('❌ Token con formato inválido');\n    return false;\n  } catch (error) {\n    console.error('❌ Error validando token:', error);\n    return false;\n  }\n}\n\n\n\n"],"names":[],"mappings":"AAAA,oCAAoC;;;;;AACpC;AAAA;;AAEO,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IACpC,IACE,SAAS,UAAU,CAAC,cACpB,SAAS,UAAU,CAAC,YACpB,SAAS,QAAQ,CAAC,QAClB,aAAa,YACb,SAAS,UAAU,CAAC,gBACpB,aAAa,kBACb;QACA,OAAO,6LAAA,CAAA,eAAY,CAAC,IAAI;IAC1B;IAEA,QAAQ,GAAG,CAAC,oCAAoC;IAEhD,2DAA2D;IAC3D,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,eAAe;IACjD,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,YAAY;IAE/C,QAAQ,GAAG,CAAC,uBAAuB,QAAQ,aAAa;IACxD,QAAQ,GAAG,CAAC,yBAAyB,SAAS,aAAa;IAE3D,0BAA0B;IAC1B,MAAM,kBAAkB,MAAM,aAAa,OAAO;IAElD,mBAAmB;IACnB,MAAM,kBAAkB;QAAC;QAAc;KAAW;IAClD,MAAM,kBAAkB;QAAC;QAAa;KAAS;IAE/C,MAAM,mBAAmB,gBAAgB,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC;IAC3E,MAAM,mBAAmB,gBAAgB,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC;IAE3E,QAAQ,GAAG,CAAC,YAAY;IACxB,QAAQ,GAAG,CAAC,iBAAiB;IAC7B,QAAQ,GAAG,CAAC,mBAAmB;IAE/B,wBAAwB;IACxB,IAAI,mBAAmB,kBAAkB;QACvC,QAAQ,GAAG,CAAC;QACZ,MAAM,WAAW,6LAAA,CAAA,eAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,cAAc,QAAQ,GAAG;QACxE,SAAS,OAAO,CAAC,GAAG,CAAC,iBAAiB;QACtC,OAAO;IACT;IAEA,IAAI,CAAC,mBAAmB,kBAAkB;QACxC,QAAQ,GAAG,CAAC;QACZ,MAAM,WAAW,6LAAA,CAAA,eAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,aAAa,QAAQ,GAAG;QACvE,SAAS,OAAO,CAAC,GAAG,CAAC,iBAAiB;QACtC,OAAO;IACT;IAEA,QAAQ,GAAG,CAAC;IACZ,OAAO,6LAAA,CAAA,eAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;KAAwD;AACpE;AAEA,eAAe,aAAa,KAAc,EAAE,MAAe;IACzD,IAAI,CAAC,SAAS,CAAC,QAAQ;QACrB,QAAQ,GAAG,CAAC;QACZ,OAAO;IACT;IAEA,IAAI;QACF,qCAAqC;QACrC,IAAI,MAAM,KAAK,CAAC,KAAK,MAAM,KAAK,GAAG;YACjC,MAAM,UAAU,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,CAAC,IAAI,CAAC,EAAE;YAEnD,uBAAuB;YACvB,IAAI,QAAQ,GAAG,IAAI,QAAQ,GAAG,GAAG,OAAO,KAAK,GAAG,IAAI;gBAClD,QAAQ,GAAG,CAAC;gBACZ,OAAO;YACT;YAEA,mCAAmC;YACnC,IAAI,QAAQ,GAAG,KAAK,UAAU,QAAQ,MAAM,KAAK,UAAU,QAAQ,EAAE,KAAK,QAAQ;gBAChF,QAAQ,GAAG,CAAC;gBACZ,OAAO;YACT;YAEA,QAAQ,GAAG,CAAC;YACZ,OAAO;QACT;QAEA,QAAQ,GAAG,CAAC;QACZ,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO;IACT;AACF"}}]
}